<?xml version="1.0" encoding="UTF-8"?>
<jube>

  <benchmark name="cqr2" outpath="supek_test">
    <comment>shifted choleskyQR3 with NCCL</comment>
    
    <parameterset name="configuration">
      <parameter name="root_path">/lustre/group/UIP-2020-02-4559/cholesky_qrbgs</parameter>
      <parameter name="build_path">${root_path}/build-gnu-shifted</parameter>
      <parameter name="matrix_path">/lustre/group/UIP-2020-02-4559/DATA/cholesky_qr/matrix_30kx3k_cond01-15</parameter>
     </parameterset>
    
    <!-- job configuration pararameter -->
    <parameterset name="systemParameter" init_with="platform.xml">
      <parameter name="queue">gpu</parameter>
      <parameter name="args_exec">--m ${m} --n ${n} --b ${panel_size} --input=${inputmatrix}</parameter>
      <parameter name="executable_versions">scqr3_gpu,scqr3_gpu_nccl</parameter>
      <parameter name="executable" separator=";">${build_path}/${executable_versions}</parameter> 
      <parameter name="timelimit">00:10:00</parameter>
      
      <parameter name="nodes" type="int">1</parameter>
      <parameter name="taskspernode" type="int">4</parameter>
      <parameter name="threadspertask" type="int">16</parameter>
      <parameter name="gpu" type="int">4</parameter>
      <parameter name="measurement">time -p</parameter>
      <parameter name="project">UIP-2020-02-4559</parameter>
      <parameter name="env" separator=";">
$jube_wp_envstr
export CUDA_VISIBLE_DEVICES=0,1,2,3
echo "cuda visible devices $CUDA_VISIBLE_DEVICES"
source ${root_path}/supek_activate_gnu.sh

      </parameter>
      
    </parameterset>
    
    <parameterset name="input_param">
      <parameter name="m" typ="int">30000</parameter> 
      <parameter name="n" typ="int">3000</parameter> 
      <!--<parameter name="panel_size" typ="int">100,200,500,1000,2000,3000,5000,10000</parameter> -->
      <parameter name="panel_size" typ="int" mode="python">$n</parameter>
      <parameter name="cond_num" typ="int">00,01,02,03,04,05,06,07,08,09,10,11,12,13,14,15</parameter>
      <parameter name="matrixname">matrix_30000_3000_1.0e+${cond_num}_1.bin</parameter>
      <parameter name="inputmatrix">${matrix_path}/${matrixname}</parameter>
    </parameterset>
    
    <step name="execute" iterations="10">
      <use>configuration</use>
      <use>input_param</use>
      <use>systemParameter</use>
      <use from="platform.xml">executeset</use>
      <use from="platform.xml">executesub</use>
      <use from="platform.xml">jobfiles</use>
      <do done_file="$done_file">$submit -W umask=007 $submit_script</do>
    </step>

    <!-- 888888888888888888888888888888888888888888888888888888888888888888888888888 -->
    
    <!-- pattern definitions used to create the result table -->
    <patternset name="pattern">
      <pattern name="ortho" type="float" dotall="False" mode="pattern">orthogonality: $jube_pat_fp</pattern>
      <pattern name="res" type="float" dotall="False" mode="pattern">residuals: $jube_pat_fp</pattern>
      <pattern name="totaltime" type="float" dotall="False" mode="pattern">algorithm: Value: $jube_pat_fp</pattern>
      <pattern name="computation" type="float" dotall="False" mode="pattern">computation: Value: $jube_pat_fp</pattern>
      <pattern name="communication" type="float" dotall="False" mode="pattern">communication: Value: $jube_pat_fp</pattern>
    </patternset>
    
    <!-- use pattern to analyse previous steps -->
    <analyser name="analyse" reduce="true">
      <use>pattern</use>
      <analyse step="execute">
        <file>job.out</file>
      </analyse>
    </analyser>

    <result>
      <use>analyse</use>
      <table name="result-stats" style="pretty" separator="," transpose="False" sort="executable_versions,cond_num">
        <column>executable_versions</column>
        <column>m</column>
        <column>n</column>
        <column>panel_size</column>
        <column>cond_num</column>
        <column>tasks</column>
        <column>ortho_avg</column>
        <column>res_avg</column>
        <column>totaltime_avg</column>
        <column>totaltime_min</column>
        <column>totaltime_max</column>
        <column>totaltime_std</column>
      </table>
    </result>

    <!-- create result table -->
    <result>
      <use>analyse</use>
      <table name="result" style="pretty" separator="," transpose="False" sort="executable_versions,cond_num">
        <column>executable_versions</column>
        <column>m</column>
        <column>n</column>
        <column>panel_size</column>
        <column>cond_num</column>
        <column>tasks</column>
        <column>ortho_avg</column>
        <column>res_avg</column>
        <column>totaltime_avg</column>
        <column>computation_avg</column>
        <column>communication_avg</column>
      </table>
    </result>
    
    <!-- create csv table -->
    <!--<result>
      <use>analyse</use>
      <table name="result-csv" style="csv" separator="," transpose="False" sort="executable_versions,cond_num">
        <column>executable_versions</column>
        <column>m</column>
        <column>n</column>
        <column>panel_size</column>
        <column>cond_num</column>
        <column>tasks</column>
        <column>ortho_avg</column>
        <column>res_avg</column>
        <column>totaltime_avg</column>
        <column>computation_avg</column>
        <column>communication_avg</column>
      </table>
    </result>-->
    
  </benchmark>
</jube>
