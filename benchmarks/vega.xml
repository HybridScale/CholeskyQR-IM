<?xml version="1.0" encoding="UTF-8"?>
<jube>

  <benchmark name="cqr2" outpath="vega_test">
    <comment>cqr2 vega test</comment>
    
    <parameterset name="configuration">
      <!-- <parameter name="matrix_path">/ceph/hpc/data/EU2010PA6234/DATA/cqr2_matrix/matrix</parameter> -->
      <parameter name="matrix_path">/ceph/hpc/home/eunenadm/workspace/cholesky_qrbgs</parameter>
      <parameter name="build_path">/ceph/hpc/home/eunenadm/workspace/cholesky_qrbgs/build</parameter>
    </parameterset>
    
    <!-- job configuration pararameter -->
    <parameterset name="systemParameter" init_with="platform.xml">
      <parameter name="queue">gpu</parameter>
      <parameter name="args_exec">--m ${m} --n ${n} --b ${b} --input=${inputmatrix}</parameter>
      <parameter name="executable_versions">cqr2_gpu,cqr2_gpu_nccl,cqr2_gpu_lookahead,cqr2_gpu_lookahead_nccl</parameter> 
      <parameter name="executable">${build_path}/${executable_versions}</parameter> 
      <parameter name="timelimit">00:10:00</parameter>
      
      <parameter name="nodes" type="int">2</parameter>
      <parameter name="taskspernode" type="int">4</parameter>
      <parameter name="threadspertask" type="int">32</parameter>
      <parameter name="gpu" type="int">4</parameter>
      <parameter name="gres">gpu:$gpu</parameter>
      <parameter name="measurement">time -p</parameter>
      <parameter name="env" separator=";">
$jube_wp_envstr
      </parameter>
      
    </parameterset>
    
    <parameterset name="input_param">
      <parameter name="m" typ="int">100000</parameter> 
      <parameter name="n" typ="int">1000</parameter> 
      <parameter name="b" typ="int">100,200,500,1000</parameter>
      <parameter name="matrixname">matrix_300000_3000_1.0e+05_1.bin</parameter>
      <parameter name="inputmatrix">${matrix_path}/${matrixname}</parameter>
    </parameterset>

    <parameterset name="executeset" init_with="platform.xml">
	    <parameter name="starter">srun --mpi=pmix_v3</parameter>
    </parameterset>
    
    <step name="execute" iterations="1">
      <use>configuration</use>
      <use>input_param</use>
      <use>systemParameter</use>
      <use>executeset</use>
      <use from="platform.xml">executesub</use>
      <use from="platform.xml">jobfiles</use>
      <do done_file="$done_file">$submit $submit_script</do>
    </step>

    <!-- 888888888888888888888888888888888888888888888888888888888888888888888888888 -->
    
    <!-- pattern definitions used to create the result table -->
    <patternset name="pattern">
      <pattern name="ortho" type="float" dotall="False" mode="pattern">orthogonality: $jube_pat_fp</pattern>
      <pattern name="res" type="float" dotall="False" mode="pattern">residuals: $jube_pat_fp</pattern>
      <pattern name="totaltime" type="float" dotall="False" mode="pattern">lgorithm: Value: $jube_pat_fp</pattern>
      <pattern name="computation" type="float" dotall="False" mode="pattern">ommunication: Value: $jube_pat_fp</pattern>
      <pattern name="communication" type="float" dotall="False" mode="pattern">computation: Value: $jube_pat_fp</pattern>
    </patternset>
    
    <!-- use pattern to analyse previous steps -->
    <analyser name="analyse"><!-- reduce="false"> -->
      <use>pattern</use>
      <analyse step="execute">
        <file>job.out</file>
      </analyse>
    </analyser>

    <!-- create result table -->
    <result>
      <use>analyse</use>
      <table name="result" style="pretty" separator="," transpose="False" sort="version">
        <column>executable_versions</column>
        <column>tasks</column>
        <column>jube_wp_id</column>
        <column>ortho</column>
        <column>res</column>
        <column>totaltime</column>
        <column>computation</column>
        <column>communication</column>
      </table>
    </result>
    
  </benchmark>
</jube>
